name: Build, Push and Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      ########################################
      # 1️⃣ Checkout code
      ########################################
      - name: Checkout code
        uses: actions/checkout@v4

      ########################################
      # 2️⃣ Login to Docker Hub
      ########################################
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      ########################################
      # 3️⃣ Build and Push Docker Image
      ########################################
      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/devops-3tier-heroku-github-actions:latest
            ${{ secrets.DOCKER_USERNAME }}/devops-3tier-heroku-github-actions:${{ github.sha }}

      ########################################
      # 4️⃣ Deploy to EC2 via SSH
      ########################################
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -ex

            echo "=============================="
            echo "Starting Production Deployment"
            echo "=============================="

            ########################################
            # Set environment variables from GitHub Secrets
            ########################################
            DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
            DOCKER_PASSWORD="${{ secrets.DOCKER_PASSWORD }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            DB_NAME="${{ secrets.DB_NAME }}"

            ########################################
            # Docker login on EC2
            ########################################
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

            ########################################
            # Clean deployment directory and clone repo
            ########################################
            rm -rf /home/ubuntu/myapp
            mkdir -p /home/ubuntu/myapp
            cd /home/ubuntu/myapp
            git clone https://github.com/zahid-IT/devops-3tier-heroku-github-actions.git .

            ########################################
            # Create .env file safely
            ########################################
            echo "DOCKER_USERNAME=$DOCKER_USERNAME" > .env
            echo "DB_USER=$DB_USER" >> .env
            echo "DB_PASSWORD=$DB_PASSWORD" >> .env
            echo "DB_NAME=$DB_NAME" >> .env

            ########################################
            # Verify .env file
            ########################################
            ls -la
            cat .env

            ########################################
            # Pull latest Docker image
            ########################################
            docker pull $DOCKER_USERNAME/devops-3tier-heroku-github-actions:latest

            ########################################
            # Stop old containers
            ########################################
            docker compose --env-file .env down || true

            ########################################
            # Start new containers
            ########################################
            docker compose --env-file .env up -d

            ########################################
            # Show running containers
            ########################################
            docker compose --env-file .env ps

            ########################################
            # Cleanup unused images
            ########################################
            docker image prune -f

            echo "=============================="
            echo "Deployment Completed Successfully"
            echo "=============================="
